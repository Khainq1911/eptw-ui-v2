name: Docker CI/CD pipeline

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    # needs: check_quality # Nếu bật job trên, job này sẽ đợi check_quality xong mới chạy
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push the Docker image
        # Chỉ push khi không phải là Pull Request (tức là chỉ push khi merge vào master)
        if: ${{ github.event_name != 'pull_request' }}
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/eptw-ui:latest

  # --- JOB: DEPLOY (CD) ---
  # Job này dùng để tự động deploy lên server sau khi build xong Docker image.
  deploy:
    runs-on: ubuntu-latest
    needs: build_and_push # Chạy sau khi job build_and_push thành công
    if: ${{ github.ref == 'refs/heads/master' }} # Chỉ deploy khi code ở nhánh master
    steps:
      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            # Navigate to the project directory (Change this to your actual project path)
            cd ./eptw-fe/eptw-ui-v2
            
            # 1. Pull source code mới nhất
            git pull origin master

            # 2. Build và chạy lại container bằng Docker Compose
            docker compose up -d --build
            
            # Optional: Prune unused images
            docker image prune -f
